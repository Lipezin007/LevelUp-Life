<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skill Routine • Login</title>
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 20px; max-width: 720px; }
    h1 { margin: 0 0 10px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; max-width:520px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { font-size: 13px; color: #333; }
    input, button { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; width: 100%; }
    button { cursor: pointer; width: auto; }
    button.primary { border-color: #111; background: #111; color: #fff; }
    .muted { color: #666; font-size: 13px; }
    .check { display:flex; align-items:center; gap:8px; user-select:none; }
    .check input { width:auto; }
  </style>
</head>
<body>
  <h1>Skill Routine</h1>
  <div class="muted">Entre na sua conta para acessar suas skills.</div>

  <div class="card" style="margin-top:14px;">
    <h2 style="margin:0 0 8px;">Login</h2>

    <div class="row">
      <div style="flex:1; min-width:240px;">
        <label>Email</label><br/>
        <input id="email" type="email" placeholder="seu@email.com" />
      </div>
      <div style="flex:1; min-width:200px;">
        <label>Senha</label><br/>
        <input id="pass" type="password" placeholder="******" />
      </div>
    </div>

    <div class="row" style="margin-top:10px; justify-content:space-between;">
      <label class="check">
        <input id="remember" type="checkbox" checked />
        <span>Lembrar-me</span>
      </label>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="primary" id="btnLogin">Entrar</button>
      <button id="btnRegister">Criar conta</button>
    </div>

    <div class="muted" id="msg" style="margin-top:10px;"></div>
  </div>

<script type="module">
const TOKEN_KEY = "skillRoutine_token";
const REMEMBER_KEY = "skillRoutine_remember";

// token pode estar no localStorage (persistente) OU sessionStorage (até fechar)
function getToken(){
  return localStorage.getItem(TOKEN_KEY) || sessionStorage.getItem(TOKEN_KEY);
}

function setToken(token, remember){
  // limpa dos dois pra não ficar duplicado
  localStorage.removeItem(TOKEN_KEY);
  sessionStorage.removeItem(TOKEN_KEY);

  if (!token) return;

  if (remember) localStorage.setItem(TOKEN_KEY, token);
  else sessionStorage.setItem(TOKEN_KEY, token);
}

async function apiFetch(url, opts = {}) {
  const headers = { "Content-Type": "application/json", ...(opts.headers || {}) };
  const res = await fetch(url, { ...opts, headers });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || "Erro na API");
  return data;
}

// carregar preferência "lembrar-me"
const elRemember = document.getElementById("remember");
const savedRemember = localStorage.getItem(REMEMBER_KEY);
if (savedRemember !== null) elRemember.checked = (savedRemember === "1");

elRemember.addEventListener("change", () => {
  localStorage.setItem(REMEMBER_KEY, elRemember.checked ? "1" : "0");
});

// Se já tem token, tenta validar puxando state. Se ok -> app.
(async () => {
  const token = getToken();
  if (!token) return;

  try {
    const res = await fetch("/api/state", {
      method: "GET",
      headers: { Authorization: `Bearer ${token}` }
    });
    if (res.ok) window.location.href = "/app";
  } catch {}
})();

const elEmail = document.getElementById("email");
const elPass = document.getElementById("pass");
const elMsg = document.getElementById("msg");

function tryLoginOnEnter(e) {
  if (e.key === "Enter") {
    document.getElementById("btnLogin").click();
  }
}

elEmail.addEventListener("keydown", tryLoginOnEnter);
elPass.addEventListener("keydown", tryLoginOnEnter);

document.getElementById("btnRegister").addEventListener("click", async () => {
  try {
    elMsg.textContent = "Criando conta...";
    const { token, email } = await apiFetch("/auth/register", {
      method: "POST",
      body: JSON.stringify({ email: elEmail.value.trim(), password: elPass.value })
    });

    setToken(token, elRemember.checked);

    elMsg.textContent = `Conta criada: ${email}. Indo para o app...`;
    window.location.href = "/app";
  } catch (e) {
    elMsg.textContent = e.message;
  }
});

document.getElementById("btnLogin").addEventListener("click", async () => {
  try {
    elMsg.textContent = "Entrando...";
    const { token, email } = await apiFetch("/auth/login", {
      method: "POST",
      body: JSON.stringify({ email: elEmail.value.trim(), password: elPass.value })
    });

    setToken(token, elRemember.checked);

    elMsg.textContent = `Logado como ${email}. Indo para o app...`;
    window.location.href = "/app";
  } catch (e) {
    elMsg.textContent = e.message;
  }
});
</script>
</body>
</html>
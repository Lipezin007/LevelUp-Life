<!-- server/public/app.html -->
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skill Routine ‚Ä¢ App</title>
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 20px; max-width: 1100px; }
    h1 { margin: 0 0 10px; }
    .grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { font-size: 13px; color: #333; }
    input, select, button { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    button.primary { border-color: #111; background: #111; color: #fff; }
    .muted { color: #666; font-size: 13px; }
    .skills { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .skill { border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .skill-top { display:flex; justify-content: space-between; gap: 8px; }
    .bar { height: 10px; background:#eee; border-radius: 999px; overflow:hidden; margin-top: 8px; }
    .bar > div { height:100%; background:#111; width: 0%; }
    .pill { font-size: 12px; background:#f3f3f3; padding: 4px 8px; border-radius: 999px; }
    .hr { height: 1px; background:#eee; margin: 12px 0; }
    .quests { display:grid; gap: 8px; }
    .quest { border: 1px dashed #ccc; border-radius: 12px; padding: 10px; display:flex; justify-content: space-between; gap: 10px; align-items: center; }
    .quest strong { font-size: 14px; }
    .log { max-height: 240px; overflow:auto; display:grid; gap: 8px; }
    .log-item { border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .danger { border-color: #c00; color:#c00; }

    /* ===== MODAL XP ===== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 16px;
    }
    .modal.hidden { display: none; }

    .modal-box {
      background: #fff;
      border-radius: 14px;
      padding: 20px 24px;
      max-width: 360px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
    }
    .modal-box h3 { margin: 0 0 10px; }
    .modal-box p { font-size: 14px; color: #444; margin: 0 0 14px; line-height: 1.35; }
  </style>
</head>

<body>
  <div class="row" style="justify-content:space-between;">
    <div>
      <h1>Skill Routine</h1>
      <div class="muted">Gamificado ‚Ä¢ XP por atividade ‚Ä¢ n√≠veis por skill ‚Ä¢ quests di√°rias ‚Ä¢ sua conta salva no servidor local.</div>
    </div>
    <div class="row">
      <span class="pill" id="who"></span>
      <button class="danger" id="btnLogout">Sair</button>
    </div>
  </div>

  <div class="grid" style="margin-top:14px;">
    <div class="card">
      <h2 style="margin:0 0 8px;">Registrar atividade</h2>

      <div class="row">
        <div>
          <label>Atividade</label><br/>
          <select id="activity"></select>
        </div>
        <div>
          <label>Minutos</label><br/>
          <input id="minutes" type="number" min="1" value="30" />
        </div>
        <div>
          <label>Dificuldade</label><br/>
          <select id="difficulty">
            <option value="facil">F√°cil</option>
            <option value="medio">M√©dio</option>
            <option value="dificil">Dif√≠cil</option>
          </select>
        </div>
        <div>
          <label>Sem distra√ß√£o?</label><br/>
          <select id="nodistraction">
            <option value="nao">N√£o</option>
            <option value="sim">Sim</option>
          </select>
        </div>
        <div style="margin-top:18px;">
          <button class="primary" id="btnComplete">Concluir (+XP)</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content: space-between;">
        <div>
          <strong>Resumo do dia</strong>
          <div class="muted" id="dayInfo"></div>
        </div>
        <div class="row">
          <button id="btnNewQuests">Gerar quests do dia</button>
          <button class="danger" id="btnReset">Resetar tudo</button>
        </div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px;">Quests di√°rias</h3>
      <div class="quests" id="quests"></div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px;">Hist√≥rico</h3>
      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;">Skills</h2>
      <canvas id="radar" width="360" height="360" style="width:100%; max-width:420px; display:block; margin: 6px auto 12px;"></canvas>
      <div class="muted" style="text-align:center; margin-bottom:10px;">
        Radar (normalizado pelo n√≠vel mais alto)
      </div>
      <div class="skills" id="skills"></div>
    </div>
  </div>

  <!-- ===== MODAL XP ===== -->
  <div id="xpModal" class="modal hidden">
    <div class="modal-box">
      <h3>‚ú® Atividade conclu√≠da</h3>
      <p id="xpText"></p>
      <button id="xpOk" class="primary">OK</button>
    </div>
  </div>

<script type="module">
/** ===== AUTH / STORAGE ===== */
const TOKEN_KEY = "skillRoutine_token";
const STORE_KEY = "skillRoutine_v1";

function getToken(){
  return localStorage.getItem(TOKEN_KEY) || sessionStorage.getItem(TOKEN_KEY);
}
function clearToken(){
  localStorage.removeItem(TOKEN_KEY);
  sessionStorage.removeItem(TOKEN_KEY);
}

// Se n√£o tem token -> manda pro login
if (!getToken()) window.location.href = "/login";

async function apiFetch(url, opts = {}) {
  const token = getToken();
  const headers = { "Content-Type": "application/json", ...(opts.headers || {}) };
  if (token) headers.Authorization = `Bearer ${token}`;
  const res = await fetch(url, { ...opts, headers });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || "Erro na API");
  return data;
}

/** ===== CONFIG: Skills e Atividades ===== */
const SKILL_CAP_DAILY = 120;

const SKILL_DEFS = {
  foco:         { name: "Foco" },
  estudo:       { name: "Estudo" },
  disciplina:   { name: "Disciplina" },
  organizacao:  { name: "Organiza√ß√£o" },
  saude:        { name: "Sa√∫de" },
  energia:      { name: "Energia" },
  criatividade: { name: "Criatividade" },
  social:       { name: "Social" }
};

const ACTIVITIES = {
  estudar:        { name: "Estudar",                 weights: { estudo: 0.7, foco: 0.2, disciplina: 0.1 } },
  revisar:        { name: "Revisar (flashcards)",     weights: { estudo: 0.6, foco: 0.3, organizacao: 0.1 } },
  ler:            { name: "Leitura",                 weights: { estudo: 0.4, foco: 0.4, disciplina: 0.2 } },
  trabalhar:      { name: "Trabalho (deep)",          weights: { foco: 0.6, disciplina: 0.3, organizacao: 0.1 } },
  planejar:       { name: "Planejar o dia",           weights: { organizacao: 0.7, disciplina: 0.3 } },
  organizarMesa:  { name: "Organizar ambiente",       weights: { organizacao: 0.8, disciplina: 0.2 } },
  treino:         { name: "Treino",                   weights: { energia: 0.6, saude: 0.3, disciplina: 0.1 } },
  caminhada:      { name: "Caminhada",                weights: { energia: 0.5, saude: 0.5 } },
  alongar:        { name: "Alongamento",              weights: { saude: 0.8, energia: 0.2 } },
  dormirBem:      { name: "Sono (higiene do sono)",   weights: { saude: 0.7, energia: 0.3 } },
  criarProjeto:   { name: "Criar/Construir projeto",  weights: { criatividade: 0.7, foco: 0.2, disciplina: 0.1 } },
  escrever:       { name: "Escrever",                 weights: { criatividade: 0.6, foco: 0.3, disciplina: 0.1 } },
  socializar:     { name: "Socializar",               weights: { social: 0.7, disciplina: 0.2, foco: 0.1 } }
};

/** ===== STATE ===== */
function todayKey() { return new Date().toISOString().slice(0, 10); }

function defaultState() {
  const skills = {};
  for (const id of Object.keys(SKILL_DEFS)) skills[id] = { level: 1, xp: 0 };
  return { createdAt: Date.now(), skills, dailyEarned:{}, questsByDay:{}, log:[] };
}

function loadStateLocal(){
  try {
    const raw = localStorage.getItem(STORE_KEY);
    return raw ? JSON.parse(raw) : defaultState();
  } catch { return defaultState(); }
}
function saveStateLocal(state){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

async function loadStateFromServerOrLocal(){
  const token = getToken();
  if (!token) return loadStateLocal();

  try {
    const { state } = await apiFetch("/api/state", { method: "GET" });
    return state || loadStateLocal();
  } catch {
    clearToken();
    return loadStateLocal();
  }
}

async function persistState(state){
  saveStateLocal(state); // backup local sempre
  const token = getToken();
  if (!token) return;

  try {
    await apiFetch("/api/state", { method:"PUT", body: JSON.stringify({ state }) });
  } catch (e) {
    console.error(e);
  }
}

let state = await loadStateFromServerOrLocal();

/** ===== XP ===== */
function xpToNext(level){ return 50 + level * 25; }

function computeXP({ minutes, difficulty="facil", distractionFree=false }) {
  const diffMult = difficulty === "dificil" ? 1.6 : difficulty === "medio" ? 1.3 : 1.0;
  let xp = minutes * diffMult;
  if (distractionFree) xp *= 1.1;
  return Math.round(xp);
}

function addXP(skillId, amount) {
  const day = todayKey();
  state.dailyEarned[day] ??= {};
  state.dailyEarned[day][skillId] ??= 0;

  const capLeft = Math.max(0, SKILL_CAP_DAILY - state.dailyEarned[day][skillId]);
  const applied = Math.min(amount, capLeft);

  state.skills[skillId].xp += applied;
  state.dailyEarned[day][skillId] += applied;

  while (state.skills[skillId].xp >= xpToNext(state.skills[skillId].level)) {
    state.skills[skillId].xp -= xpToNext(state.skills[skillId].level);
    state.skills[skillId].level += 1;
  }
  return applied;
}

async function completeActivity(activityId, opts) {
  const activity = ACTIVITIES[activityId];
  if (!activity) throw new Error("Atividade n√£o existe");

  const totalXP = computeXP(opts);
  const gains = {};

  for (const [skillId, w] of Object.entries(activity.weights)) {
    const portion = Math.round(totalXP * w);
    gains[skillId] = addXP(skillId, portion);
  }

  applyGainsToQuests(gains);

  state.log.unshift({ ts: Date.now(), activityId, ...opts, totalXP, gains });
  state.log = state.log.slice(0, 100);

  await persistState(state);
  return { totalXP, gains };
}

/** ===== QUESTS ===== */
function getTodayQuests() {
  const day = todayKey();
  state.questsByDay[day] ??= [];
  return state.questsByDay[day];
}

function cryptoRandomId() {
  if (window.crypto?.getRandomValues) {
    const a = new Uint32Array(2);
    crypto.getRandomValues(a);
    return a[0].toString(16) + a[1].toString(16);
  }
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function makeQuest(text, skillId, target, extra = {}) {
  return { id: cryptoRandomId(), text, skillId, target, progress:0, done:false, type: extra.type ?? "xp" };
}

function generateQuestsForToday() {
  const day = todayKey();
  const skillIds = Object.keys(SKILL_DEFS);
  const pick = () => skillIds[Math.floor(Math.random() * skillIds.length)];

  const q1Skill = pick();
  const q2Skill = pick();

  state.questsByDay[day] = [
    makeQuest(`Ganhe 60 XP em ${SKILL_DEFS[q1Skill].name}`, q1Skill, 60),
    makeQuest(`Ganhe 80 XP em ${SKILL_DEFS[q2Skill].name}`, q2Skill, 80),
    makeQuest(`Complete 2 atividades hoje`, "_any", 2, { type:"count" })
  ];

  persistState(state);
}

function applyGainsToQuests(gains) {
  const quests = getTodayQuests();
  if (!quests.length) return;

  for (const q of quests) {
    if (q.done) continue;

    if (q.type === "xp") {
      if (q.skillId in gains) {
        q.progress += gains[q.skillId];
        if (q.progress >= q.target) q.done = true;
      }
    } else if (q.type === "count") {
      q.progress += 1;
      if (q.progress >= q.target) q.done = true;
    }
  }
  persistState(state);
}

/** ===== UI refs ===== */
const elWho = document.getElementById("who");
const btnLogout = document.getElementById("btnLogout");

const elActivity = document.getElementById("activity");
const elMinutes = document.getElementById("minutes");
const elDifficulty = document.getElementById("difficulty");
const elNoDistraction = document.getElementById("nodistraction");
const elSkills = document.getElementById("skills");
const elLog = document.getElementById("log");
const elQuests = document.getElementById("quests");
const elDayInfo = document.getElementById("dayInfo");
const elRadar = document.getElementById("radar");

/** ===== MODAL ===== */
function showXpModal({ totalXP, gains }) {
  const modal = document.getElementById("xpModal");
  const text = document.getElementById("xpText");

  const lines = Object.entries(gains)
    .filter(([,v]) => v > 0)
    .map(([k,v]) => `+${v} XP em ${SKILL_DEFS[k]?.name ?? k}`)
    .join("<br>");

  text.innerHTML = `<strong>Total:</strong> ${totalXP} XP<br><br>${lines || "Cap di√°rio atingido"}`;
  modal.classList.remove("hidden");
}

function closeXpModal() {
  document.getElementById("xpModal").classList.add("hidden");
}

document.getElementById("xpOk").addEventListener("click", closeXpModal);
document.getElementById("xpModal").addEventListener("click", (e) => {
  if (e.target.id === "xpModal") closeXpModal();
});

/** ===== ENTER para concluir (registrar s√≥ uma vez) ===== */
function tryCompleteOnEnter(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    document.getElementById("btnComplete").click();
  }
}

elMinutes.addEventListener("keydown", tryCompleteOnEnter);
elDifficulty.addEventListener("keydown", tryCompleteOnEnter);
elNoDistraction.addEventListener("keydown", tryCompleteOnEnter);
elActivity.addEventListener("keydown", tryCompleteOnEnter);

/** ===== RENDER ===== */
function initActivitySelect() {
  elActivity.innerHTML = "";
  for (const [id, a] of Object.entries(ACTIVITIES)) {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = a.name;
    elActivity.appendChild(opt);
  }
}

function renderSkills() {
  elSkills.innerHTML = "";
  for (const [id, def] of Object.entries(SKILL_DEFS)) {
    const s = state.skills[id];
    const next = xpToNext(s.level);
    const pct = Math.min(100, Math.round((s.xp / next) * 100));

    const div = document.createElement("div");
    div.className = "skill";
    div.innerHTML = `
      <div class="skill-top">
        <strong>${def.name}</strong>
        <span class="pill">Lv ${s.level}</span>
      </div>
      <div class="muted">${s.xp} / ${next} XP</div>
      <div class="bar"><div style="width:${pct}%"></div></div>
    `;
    elSkills.appendChild(div);
  }
}

function renderLog() {
  elLog.innerHTML = "";
  if (!state.log.length) {
    elLog.innerHTML = `<div class="muted">Sem registros ainda.</div>`;
    return;
  }

  for (const item of state.log) {
    const a = ACTIVITIES[item.activityId];
    const date = new Date(item.ts);
    const gainsTxt = Object.entries(item.gains)
      .filter(([,v]) => v > 0)
      .map(([k,v]) => `${SKILL_DEFS[k].name}: +${v}`)
      .join(" ‚Ä¢ ") || "(cap di√°rio atingido)";

    const div = document.createElement("div");
    div.className = "log-item";
    div.innerHTML = `
      <strong>${a?.name ?? item.activityId}</strong>
      <div class="muted">${date.toLocaleString()} ‚Ä¢ ${item.minutes} min ‚Ä¢ ${item.difficulty} ‚Ä¢ sem distra√ß√£o: ${item.distractionFree ? "sim" : "n√£o"}</div>
      <div>${gainsTxt}</div>
    `;
    elLog.appendChild(div);
  }
}

function renderQuests() {
  const quests = getTodayQuests();
  elQuests.innerHTML = "";

  if (!quests.length) {
    elQuests.innerHTML = `<div class="muted">Nenhuma quest hoje. Clique em "Gerar quests do dia".</div>`;
    return;
  }

  for (const q of quests) {
    const div = document.createElement("div");
    div.className = "quest";
    const right = q.type === "xp"
      ? `${Math.min(q.progress, q.target)}/${q.target} XP`
      : `${Math.min(q.progress, q.target)}/${q.target}`;

    div.innerHTML = `
      <div>
        <strong>${q.done ? "‚úÖ " : "üéØ "}${q.text}</strong>
        <div class="muted">Progresso: ${right}</div>
      </div>
      <span class="pill">${q.done ? "Conclu√≠da" : "Em progresso"}</span>
    `;
    elQuests.appendChild(div);
  }
}

function renderDayInfo() {
  const day = todayKey();
  const earned = state.dailyEarned[day] || {};
  const total = Object.values(earned).reduce((a,b)=>a+b,0);
  const top = Object.entries(earned).sort((a,b)=>b[1]-a[1]).slice(0,3)
    .map(([k,v]) => `${SKILL_DEFS[k].name}: ${v}`)
    .join(" ‚Ä¢ ");

  elDayInfo.textContent = `Hoje (${day}): ${total} XP ganhos. ${top ? "Top: " + top : ""}`;
}

function renderRadar() {
  if (!elRadar) return;

  const ctx = elRadar.getContext("2d");
  const w = elRadar.width;
  const h = elRadar.height;
  const cx = w / 2;
  const cy = h / 2;
  const R = Math.min(w, h) / 2 - 46;

  ctx.clearRect(0, 0, w, h);

  const skillIds = Object.keys(SKILL_DEFS);
  const n = skillIds.length;

  const levels = skillIds.map(id => state.skills[id]?.level ?? 1);
  const maxLevel = Math.max(1, ...levels);
  const ringCount = 5;

  ctx.lineWidth = 1;
  ctx.strokeStyle = "#e6e6e6";
  for (let r = 1; r <= ringCount; r++) {
    const rr = (R * r) / ringCount;
    ctx.beginPath();
    for (let i = 0; i < n; i++) {
      const a = (-Math.PI / 2) + (i * 2 * Math.PI) / n;
      const x = cx + rr * Math.cos(a);
      const y = cy + rr * Math.sin(a);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.stroke();
  }

  ctx.strokeStyle = "#ddd";
  ctx.fillStyle = "#333";
  ctx.font = "12px system-ui, Arial";

  for (let i = 0; i < n; i++) {
    const a = (-Math.PI / 2) + (i * 2 * Math.PI) / n;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + R * Math.cos(a), cy + R * Math.sin(a));
    ctx.stroke();

    const label = SKILL_DEFS[skillIds[i]].name;
    const lx = cx + (R + 18) * Math.cos(a);
    const ly = cy + (R + 18) * Math.sin(a);

    const cos = Math.cos(a);
    if (cos > 0.35) ctx.textAlign = "left";
    else if (cos < -0.35) ctx.textAlign = "right";
    else ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    ctx.fillText(label, lx, ly);
  }

  const values = skillIds.map(id => (state.skills[id]?.level ?? 1) / maxLevel);

  ctx.fillStyle = "rgba(17,17,17,0.18)";
  ctx.strokeStyle = "#111";
  ctx.lineWidth = 2;

  ctx.beginPath();
  for (let i = 0; i < n; i++) {
    const a = (-Math.PI / 2) + (i * 2 * Math.PI) / n;
    const rr = R * values[i];
    const x = cx + rr * Math.cos(a);
    const y = cy + rr * Math.sin(a);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  ctx.fillStyle = "#111";
  for (let i = 0; i < n; i++) {
    const a = (-Math.PI / 2) + (i * 2 * Math.PI) / n;
    const rr = R * values[i];
    const x = cx + rr * Math.cos(a);
    const y = cy + rr * Math.sin(a);
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, 2 * Math.PI);
    ctx.fill();
  }

  ctx.fillStyle = "#666";
  ctx.font = "11px system-ui, Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  ctx.fillText(`Max Lv: ${maxLevel}`, cx, h - 18);
}

function renderAll(){
  renderSkills();
  renderRadar();
  renderLog();
  renderQuests();
  renderDayInfo();
}

/** ===== EVENTS ===== */
document.getElementById("btnComplete").addEventListener("click", async () => {
  const activityId = elActivity.value;
  const minutes = Math.max(1, Number(elMinutes.value || 1));
  const difficulty = elDifficulty.value;
  const distractionFree = (elNoDistraction.value === "sim");

  const result = await completeActivity(activityId, {
    minutes,
    difficulty,
    distractionFree
  });

  renderAll();
  showXpModal(result);
});

document.getElementById("btnNewQuests").addEventListener("click", () => {
  generateQuestsForToday();
  renderAll();
});

document.getElementById("btnReset").addEventListener("click", async () => {
  if (!confirm("Tem certeza? Isso apaga tudo e recome√ßa do zero.")) return;
  state = defaultState();
  await persistState(state);
  renderAll();
});

btnLogout.addEventListener("click", () => {
  clearToken();
  window.location.href = "/login";
});

/** ===== INIT ===== */
initActivitySelect();

// mostra quem est√° logado (decodifica JWT sem verificar assinatura)
try {
  const token = getToken();
  const payload = JSON.parse(atob(token.split(".")[1]));
  elWho.textContent = payload.email || "Logado";
} catch {
  elWho.textContent = "Logado";
}

renderAll();
</script>
</body>
</html>